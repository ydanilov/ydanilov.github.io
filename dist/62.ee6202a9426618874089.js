(self.webpackChunkrm_frontend=self.webpackChunkrm_frontend||[]).push([[62],{348:function(e,t,s){"use strict";s.r(t),s.d(t,{MagList:function(){return a}});var i=s(336),r=s.n(i),n=s(349),o=s(312),a=r().Collection.extend({model:n.w,load:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.success||o.ZP.noop;this.loaded;var s=this;return e.success=function(){t(s),s.loaded=!0},this.fetch(e)},comparator:function(e){return-new Date(e.get("major_update")).getTime()}})},349:function(e,t,s){"use strict";s.d(t,{w:function(){return m}});var i=s(336),r=s.n(i),n=s(321),o=s(340),a=s(308),u=s(323),c=s(350),d=s(312),h=s(343),l=s(346);function p(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function g(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?p(Object(s),!0).forEach((function(t){f(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):p(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function f(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}var m=r().Model.extend({idAttribute:"_id",url:function(){if(this.get("user")&&this.get("uri")){var e=this.get("user");n.Z.isObject(e)&&(e=e.get("uri"));var t=e+"/"+this.get("uri")}else t=this.getId();return"/api/readymag/"+t},PUBLISH_URL:"/api/publish/",UNPUBLISH_URL:"/api/unpublish/",parse:function(e){var t=s(348).MagList,i=s(339).UserModel;return e.user&&(this.user=new i(e.user),delete e.user),e.title||(e.emptyTitle=!0),e.title=e.title||"Project",n.Z.isEmpty(e.recentMags)||(this.recentMags=new t(e.recentMags,{parse:!0})),e},getPageNumId:function(e){if(!this.get("pages"))return"";var t=n.Z.find(this.get("pages"),(function(t){return t.num==e}));return t?t.num_id:""},getPageId:function(e){if(!this.get("pages"))return"";var t=n.Z.find(this.get("pages"),(function(t){return t.num==e}));return t?t._id:""},getPageScreenshot:function(e,t){var s,i,r,a,u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:h.sJ.Default,d=n.Z.findWhere(this.get("pages"),e),p=(0,l._)("constructor.mobileScreenshots"),f=null==d||null===(s=d.viewport_phone_portrait)||void 0===s?void 0:s.enabled,m=null==d||null===(i=d.viewport_tablet_portrait)||void 0===i?void 0:i.enabled,b=p&&u===h.sJ.PhonePortrait&&f&&(null==d||null===(r=d.viewport_phone_portrait)||void 0===r?void 0:r.screenshot),w=p&&u===h.sJ.TabletPortrait&&m&&(null==d||null===(a=d.viewport_tablet_portrait)||void 0===a?void 0:a.screenshot),v=b||w||d.screenshot,P=b?o.screenshotSize.half:o.screenshotSize.quarter,_=o.default.getScreenshotSizeByToken(P,b?h.sJ.PhonePortrait:w?h.sJ.TabletPortrait:h.sJ.Default),y=h.dc[h.sJ.Default],L=(0,h.QP)(b?h.sJ.PhonePortrait:w?h.sJ.TabletPortrait:h.sJ.Default,t);return e.specialScreenshot?g({src:e.specialScreenshot},y):e.cover?!this.get("cover")&&this.get("pages")?this.getPageScreenshot({_id:this.get("coverPid")},t,u):this.get("cover")?g({src:o.default.addFilenameComponent(this.get("cover"),_)},y):g({src:"/api/screenshot/renew/".concat(this.get("num_id"),"/").concat(this.get("coverPid"),"/").concat(this.get("is_published")?"ready":"","?viewport=").concat(u,"&redirect=true&size=").concat(_)},L):this.get("pages")?d&&d.unauthorized?g({src:this.get("pass_bg")?this.get("pass_bg"):(0,c.findImagePath)("./viewer/mag-password/bg.jpg")},y):!v&&d?g({src:"/api/screenshot/renew/".concat(this.get("num_id"),"/").concat(d._id,"/").concat(this.get("is_published")?"ready":"","?viewport=").concat(u,"&redirect=true&size=").concat(_)},L):v&&!isNaN(Number(o.default.getFilenameComponent(v)))?g({src:v},L):g({src:o.default.addFilenameComponent(v,_)},L):(console.error("cannot find page screenshot: ",this,e),g({src:void 0},y))},getLink:function(){if(!u.Z.isDesktop)return this.getUnpublishedViewerLink();var e=this.get("is_published")&&this.get("uri")||this.getId();return RM.common.customDomainProfile?"/"+e+"/":a.Z.readymag_host+"/"+this.user.get("uri")+"/"+e+"/"},getUnpublishedViewerLink:function(){return a.Z.readymag_auth_host+"/"+this.user.get("uri")+"/"+this.get("num_id")},getMagEditLink:function(){return a.Z.readymag_auth_host+"/edit/"+this.getId()+"/"},getMagEditContentsLink:function(){return u.Z.isDesktop?this.getMagEditLink()+"contents/":this.getUnpublishedViewerLink()},getMagSettingsLink:function(){return this.getMagEditLink()+"settings/"},getId:function(){return this.get("num_id")},getPagesCount:function(){return this.get("pages_count")||this.get("pages")&&this.get("pages").length},deleteMag:function(e){this.deleteXHR&&this.deleteXHR.abort(),this.deleteXHR=d.ZP.ajax({type:"DELETE",url:"/api/mags/archive",data:JSON.stringify({mag_num_ids:[Number(this.getId())],folder_num_ids:[]}),contentType:"application/json; charset=utf-8",success:function(t){"function"==typeof e.success&&e.success(t)},error:function(e){console.log("Error deleting mag: "+e.responseText),this.onError("A problem occurred while deleting your project. Please, contact us: "+a.Z.SUPPORT_MAIL)},context:this}).always((function(){"function"==typeof e.always&&e.always()}))},_changePublishState:function(e,t){var s=!e||"publish"!==e&&"republish"!==e?this.UNPUBLISH_URL:this.PUBLISH_URL;this.publishXHR&&this.publishXHR.abort(),this.publishXHR=d.ZP.ajax({type:"POST",url:s+this.getId(),success:function(s){this.set("is_published",e&&"unpublish"!==e),"publish"===e&&(this.set("published",s.published||(new Date).toISOString()),this.set("updated",s.updated||(new Date).toISOString()),this.set("major_update",s.major_update||(new Date).toISOString())),"republish"===e&&this.set(n.Z.extend(n.Z.omit(s,"user"),{updated:this.get("last_changed")})),this.set("coverPid",s.coverPid||this.get("coverPid")),this.set("cover",s.cover||this.get("cover")),"function"==typeof t.success&&t.success()},error:function(t){console.log("Error changing puplish state: "+t.responseText),this.onError("A problem occurred while "+e+"ing your project. Please, contact us: "+a.Z.SUPPORT_MAIL)},context:this}).always((function(){"function"==typeof t.always&&t.always()}))},publishMag:function(e){this._changePublishState("publish",e)},unpublishMag:function(e){this._changePublishState("unpublish",e)},republishMag:function(e){this._changePublishState("republish",e)},duplicateMag:function(e){var t;t={type:"POST",url:"/api/mag/"+this.get("num_id")+"/duplicate",context:this},n.Z.extend(t,e),this.duplicateXHR&&this.duplicateXHR.abort(),this.duplicateXHR=d.ZP.ajax(t)},hasUnsavedChanges:function(){return this.get("is_published")&&this.get("changed")},onError:function(e){alert(e)}})},339:function(e,t,s){"use strict";s.r(t),s.d(t,{UserModel:function(){return p},UsersCollection:function(){return g},UsersLoader:function(){return f},loadUser:function(){return m}});var i=s(312),r=s(336),n=s.n(r),o=s(321),a=s(308),u=s(340),c=n().Model.extend({idAttribute:"_id",urlRoot:"/api/folders/"}),d=n().Collection.extend({model:c,getByUri:function(e){return this.findWhere({uri:e})}}),h=s(348),l=s(350),p=n().Model.extend({userpic_sizes:[64,96,128,192,256],mergePermissionsList:["can_publish"],idAttribute:"uri",url:"/api/me/",SSLDOMAIN_URL:"/api/user/domain/ssl",initialize:function(){o.Z.bindAll(this)},store:function(e,t){e.name&&!/^\s$/.test(e.name)||(e.name=this.get("name")),e=this.changedAttributes(e),this.set(e),this.validate(e)||i.ZP.ajax({type:"PUT",url:this.url,data:e,success:t&&"function"==typeof t.success&&t.success,error:t&&"function"==typeof t.error&&t.error})},deletePic:function(){var e=this;i.ZP.ajax({type:"DELETE",url:"/api/me/pic/",success:function(){e.set("pic","")}})},validate:function(e){if(void 0!==e.name&&o.Z.isEmpty(i.ZP.trim(e.name)))return"Name yourself"},getUserpic:function(e){var t,s=this.get("pic");return Modernizr.retina&&(e*=2),e=o.Z.find(this.userpic_sizes,(function(t){return t>=e})),s?(0==(s=u.default.addFilenameComponent(s,e)).indexOf("https://")||RM.common.isDownloadedSource||-1==s.indexOf("/api/upload/")&&(s="/api/upload/"+s),s):(t=this.get("name").match(/^[a-z0-9]{1}/i))?(0,l.findImagePath)("./stubs/avatar/"+t[0].toLowerCase()+".gif"):(0,l.findImagePath)("./stubs/avatar/"+e+".gif")},getLink:function(){return RM.common.customDomainProfile?"/":RM.common.isDomainViewer?a.Z.readymag_host+"/"+this.get("uri"):"/"+this.get("uri")},getWebsiteButified:function(){var e,t={link:"",label:""};return this.get("website")&&((e=u.default.URLParts(this.get("website"))).protocol=e.protocol||"http://",t.link=e.protocol+e.hostname+e.path,t.label=e.hostname),t},getTwitterButified:function(){var e,t={link:"",nick:""};return this.get("twitter")&&((e=u.default.URLParts(this.get("twitter"))).protocol||e.path?(e.protocol=e.protocol||"http://",t.nick=e.path.split("/")[1]):(e.protocol="http://",t.nick=e.hostname,e.path="/"+t.nick,e.hostname="twitter.com"),t.link=e.protocol+e.hostname+e.path),t},getFacebookButified:function(){var e,t={link:"",nick:""};if(this.get("fb")){e=u.default.URLParts(this.get("fb"));try{-1!=e.path.indexOf("profile.php")?t.nick="facebook":"pages"==e.path.split("/")[1]?t.nick=decodeURIComponent(e.path.split("/")[2])||"":e.protocol||e.path?t.nick=e.path.split("/")[1].split("?")[0]||"":(t.nick=e.hostname,e.hostname="facebook.com",e.path="/"+t.nick),e.protocol=e.protocol||"http://",t.link=e.protocol+e.hostname+e.path}catch(e){console.log("Error parsing FB URL: ",e)}}return t},mergePermissions:function(e){var t=o.Z.clone(this.get("permissions"));this.set("permissions",e),o.Z.each(this.mergePermissionsList,(function(e){this.attributes.permissions[e]=this.attributes.permissions[e]&&t[e]}),this)},resendConfirmationEmail:function(){i.ZP.get("/auth/confirm/resend")},isPublisher:function(){return this.get("permissions").can_publish},checkDomain:function(e,t){return i.ZP.ajax({type:"POST",url:"/api/checkdomain",data:{type:"user",domain:e},success:o.Z.bind((function(s){this.set({last_checked_domain:e},{silent:!0}),t&&t(s)}),this),error:o.Z.bind((function(){console.error(arguments),t&&t(null)}),this)})},mapDomain:function(e,t){return t=t||{},i.ZP.ajax({type:"POST",url:"/api/user/domain/",data:{domain:e,status:"on"},success:o.Z.bind((function(s){this.set({domain:e},{silent:!0}),t.success&&t.success(s)}),this),error:o.Z.bind((function(e){return e&&e.status>=500?t.error(null):t.error&&t.error({badDNSSettings:!0})}),this)})},unmapDomain:function(e){return i.ZP.ajax({type:"POST",url:"/api/user/domain/",data:{status:"off"},success:o.Z.bind((function(t){this.unset("domain",{silent:!0}),e&&e(t)}),this),error:o.Z.bind((function(){console.error(arguments),e&&e(null)}),this)})},changeSSL:function(e,t,s){return s=s||{},i.ZP.ajax({type:"POST",url:this.SSLDOMAIN_URL,data:{domain:e,status:t?"on":"off"},success:o.Z.bind((function(e){s.success&&s.success(e)}),this),error:o.Z.bind((function(e){return console.log(e),e&&e.status>=500?s.error(null):s.error&&s.error(e.responseJSON)}),this)})},getSSLState:function(e,t){return i.ZP.ajax({type:"GET",url:this.SSLDOMAIN_URL,data:{domain:e,type:"user"},success:o.Z.bind((function(e){t.success&&t.success(e)})),error:o.Z.bind((function(e){return e&&e.status>=500?t.error(null):t.error&&t.error(e.responseJSON)}))})},isBetaTester:function(){return!!(this.get("permissions")||{}).can_use_beta_testing}}),g=n().Collection.extend({model:p}),f=function(){this.allUsers=new g,this.userMags={},this.userFolders={},o.Z.bindAll(this)};f.prototype={LOAD_URL:"/api/readymags/user/",loadByUsername:function(e){if(RM.common.customDomainProfile&&this.allUsers.at(0)){var t=this.allUsers.at(0),s=this.userMags[this.allUsers.at(0).get("uri")];return t.folders=this.userFolders[this.allUsers.at(0).get("uri")],e.success&&e.success({user:t,mags:s})}var i=this.allUsers.find((function(t){return t.get("uri").toLowerCase()==e.user_uri.toLowerCase()})),r=o.Z.bind((function(t){var s,i;if(!t.user)return e.success({user:t});this.load(t,e.is_me),s=this.allUsers.get(t.user.uri),i=this.userMags[t.user.uri],s.folders=this.userFolders[t.user.uri],e.success&&e.success({user:s,mags:i})}),this);i&&!e.force?(s=this.userMags[i.get("uri")],i.folders=this.userFolders[i.get("uri")],e.success({user:i,mags:s})):this.request(e.user_uri,{success:r,error:e.error})},load:function(e,t){var s;if(!o.Z.isEmpty(e)){var i=e.user||e,r=e.mags,n=i.folders||[];if(i){s=i.uri,d&&(this.userFolders[s]=new d(n,{parse:!0}),delete i.folders),this.allUsers.remove(s),this.allUsers.add(i),t&&i.contributors&&o.Z.each(i.contributors,(function(e){e.member&&(e.member=new p(e.member))}));var a=o.Z.pick(i,"_id","uri","desc","pic");t&&(a.isMe=t),o.Z.each(r,(function(e){e.user=o.Z.clone(a)})),h.MagList&&(this.userMags[s]=new h.MagList(r,{parse:!0}),t&&!o.Z.isEmpty(r)&&this.userMags[s].each((function(e){e.user.set("isMe",!0)})))}}},loadShared:function(e){o.Z.isEmpty(e)||(this.sharedMags={},o.Z.each(e,(function(e){var t=o.Z.pick(e.user,"_id","uri","desc","pic");o.Z.each(e.mags,(function(e){e.user=o.Z.clone(t)})),this.sharedMags[e.user.uri.toLowerCase()]={user:new p(e.user),mags:new h.MagList(e.mags,{parse:!0})}}),this))},request:function(e,t){RM.common.customDomainProfile&&(this.LOAD_URL="/api/domain/readymags/user/",e=""),t=t||{},this.abortLoading(),this.loadingXHR=i.ZP.ajax(o.Z.extend(t,{type:"GET",url:this.LOAD_URL+e}))},abortLoading:function(){this.loadingXHR&&this.loadingXHR.abort&&this.loadingXHR.abort()}};var m=function(){window.RM.data.usersLoader=new f;var e=window.ServerData.me;window.RM.data.usersLoader.load(e,!0),e?(e=e.user||e).uri&&(window.RM.data.usersLoader.me=window.RM.data.usersLoader.allUsers.get(e.uri)):window.RM.data.usersLoader.me=!1,window.ServerData.mags&&window.ServerData.mags.user&&window.ServerData.mags.mags&&(!window.RM.data.usersLoader.me||window.RM.data.usersLoader.me.get("uri")!==window.ServerData.mags.user.uri)&&window.RM.data.usersLoader.load(window.ServerData.mags),window.ServerData.shared&&window.RM.data.usersLoader.loadShared(window.ServerData.shared),o.Z.isEmpty(window.ServerData.sharedError)||(window.RM.data.usersLoader.sharedError=window.ServerData.sharedError)}},350:function(e,t,s){"use strict";s.d(t,{folderImagesPath:function(){return i},findImagePath:function(){return r},is2X:function(){return n}});var i="undefined"!=typeof window&&window.chunkURL||"https://d1id5eheivyv24.cloudfront.net/8d348a50/dist/",r=function(e){return"".concat(i,"img").concat(e.substring(1))},n="undefined"!=typeof window&&window.devicePixelRatio>=2}}]);